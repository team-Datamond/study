## 7강 조건 분기, 집합 연산, 윈도우 함수, 갱신

### SQL과 조건 분기

- CASE 식의 구문

  - 단순 CASE 식
  - ⭐️ 검색 CASE 식

- 교환 규칙이 어느정도 잡혀 있다면, 교환 정의를 사용하는 것이 좋다.

### SQL의 집합 연산

- 합집합 UNION
- 교집합 INTERSECT
- 차집합 EXCEPT

- 레코드의 모든 필드가 동일할때만 UNION 중복 처리?

```sql
select * from (
	select 'a' as a, 'b' as q, 'c' as h
) as tbl
UNION ALL
select * from (
	select 'a' as a, 'd' as e, 'e' as c
) as tbl2
```

---

Q. 위 결과는 어떻게 나올까요?

---

### 윈도우 함수

- 순위 함수

  - `RANK` : ORDER BY를 포함한 쿼리문에서 특정 컬럼의 순위를 구하는 함수이다. PARTITION 내에서 순위를 구할 수도 있고 전체 데이터에 대한 순위를 구할 수도 있다. 동일한 값에 대해서는 같은 순위를 부여하며 중간 순위를 비운다.
  - `DENSE_RANK` : RANK와 작동법은 동일, 동일한 값에 대해서는 같은 순위를 부여하고 중간 순위를 비우지 않는다. 동일한 값이 있는 경우 순위는 1,1,2,3,3,4 이런 식
  - `ROW_NUMBER` : RANK, DENSE_RANK는 동일한 값에 대해 동일 순위를 부여하지만 ROW_NUMBER은 동일한 값이어도 고유한 순위를 부여한다.

- 일반 집계 함수
  - SUM
  - MAX
  - MIN
  - AVG
  - COUNT
- 그룹 내 행 순서 함수

  - `FIRST_VALUE` : 파티션별 윈도우에서 가장 먼저 나온 값을 구한다. 공동 등수를 인정하지 않고 처음 나온 행만 가져오며 MIN함수를 쓰는 것과 결과가 동일하다.
  - `LAST_VALUE` : 파티션별 윈도우에서 가장 마지막에 나온 값을 구한다. 공동 등수를 인정하지 않고 마지막에 나온 행만 가져오며 MAX함수를 쓰는 것과 결과가 동일하다.
  - `LAG` :
    이전 몇 번째 행의 값을 가져오는 함수이다. 인자를 최대 3개까지 가진다.
    두번째 인자는 몇 번째 앞의 행을 가져올지 결정하는 것이며 DEFAULT값은 1이다. 세번째 인자는 가져올 행이 없을 경우 DEFAULT값을 지정해주는 것으로 NVL이나 ISNULL함수의 기능과 동일하다.
  - `LEAD` : 이후 몇 번째 행의 값을 가져오는 함수로 LAG와 마찬가지로 인자를 최대 3개까지 갖는다.

- 그룹 내 비율 함수

  - `RATIO_TO_REPROT` : 파티션 내 전체 SUM값에 대한 행별 컬럼 값의 백분율을 소수점으로 출력한다. 결과값은 0~1 사이이며 개별 비율의 합을 구하면 1이다.
  - `PERCENT_RANK` : 파티션별로 가장 먼저 나오는 값을 0, 가장 마지막에 나오는 값을 1로 해서 행 순서별 백분율 출력한다. 구간을 나누어 백분율로 표시한다.
  - `CUME_DIST` : 파티션별 전체건수에서 현재 행보다 작거나 같은 건수에 대한 누적백분율을구한다.
  - `NTILE` : 파티션별 전체 건수를 ARGUMENT값으로 N등분한 결과를 출력한다.

- 윈도우 함수 참고 링크 : https://for-my-wealthy-life.tistory.com/48

---

### 윈도우 함수 관련 퀴즈

Q. 그룹 내 비율 함수를 이용하여 설문조사 통계값 구하기

Q. 순위함수를 이용하여 전체기간 유저 획득 경험치 순위로 정렬

    - 10% / 30% / 60% / 100% 구분
    - 기간별 정렬 (6월 기준)

---

# 3장. SQL 조건 분기

- UNION : 실행 계획을 알아보고 사용하자
- 정확한 판단 없는 UNION 사용 회피

- WHERE 에서 조건 분기를 하면 초보자 = 나
- 구문에서 식으로 사고를 변경하는 것이 SQL을 마스터하는 열쇠 중 하나

- WHERE 구에서 조건 분기를 하는 사람 초보자
- HAVING구에서 조건 분기를 하는 사람 초보자

## 그래도 UNION이 필요한 경우

- UNION을 사용할 수 밖에 없는 경우

1. 사용하는 테이블이 다른 경우
2. UNION을 사용했을 때 좋은 인덱스를 사용하지만, 이외의 경우에는 테이블 풀 스캔이 발생한다면, UNION을 사용한 방법이 성능적으로 더 좋을 수 있다.

## 절차 지향형과 선언형

- 예외적인 몇 가지 상황을 제외하면 UNION을 사용하지 않는 것이 성능적으로도 좋고 가독성도 좋다.
- 구문에서 식으로의 페러다임 전환 연습
